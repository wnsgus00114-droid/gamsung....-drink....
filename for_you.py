# 여러분은 코딩을 어떻게 시작하게 되셨나요?
# 저는 중학생 때 우연히 블록코딩을 접하면서 처음 코딩이라는 걸 알게 됐어요.
# 그때는 그냥 재미있는 취미처럼 이것저것 만지작거리면서 놀았던 것 같아요.
# 그러다가 대학교 1학년 때 파이썬 수업을 듣게 되면서
# “아, 이게 내가 계속 해보고 싶은 분야일 수도 있겠다”라는 생각이 들었어요.
# 군대를 다녀온 이후에 진로를 진지하게 고민하게 되었고,
# 여러 갈림길 앞에서 결국 이런 생각이 들더라구요.
# “그래도 내가 좋아하는 걸 해보자.”
# 그래서 지금 이 길을 선택하게 되었습니다.
# 물론, 그 과정에서 많은 고민과 불안도 있었지만,
# 결국은 내가 좋아하는 걸 하는 게 가장 중요하다고 생각했어요.
# 여러분이 코딩을 공부하게 된 계기는 모두 다를 거라고 생각해요.
# 취업 때문일 수도 있고, 재미 때문일 수도 있고,
# 누군가의 영향을 받았을 수도 있고, 그냥 호기심일 수도 있겠죠.
# 어떤 이유로 시작했든, 그건 여러분의 선택이고,
# 그 선택이 여러분을 여기까지 오게 한 거니까요.
# 그리고 그 이유가 무엇이든, 그걸로 충분히 멋진 시작이라고 생각해요.
# 저는 여러분의 꿈과 목표를 응원합니다. ㅎㅎ
# 저는 그 이유가 무엇이든 상관없다고 생각해요.
# 우리가 살아가면서 ‘도전’한다는 것 자체가 정말 중요하다고 생각하거든요.
# 도전을 통해 우리는 성장하고, 새로운 것을 배우고,
# 결국 더 나은 사람이 되어간다고 믿어요.
# 때로는 도전이 두렵기도 하고, 실패할까봐 걱정도 되지만,
# 그 두려움과 걱정도 결국은 우리가 성장하는 과정의 일부라고 생각해요.
# 여러분 혹시 어렸을때는 어떤 꿈을 꾸셨나요?
# 저는 어렸을 때 피아니스트가 되고싶었어요. 음악을 정말 좋아했거든요.
# 그렇게 음대를 열심히 준비했었어요. 그런데 결국은 그 꿈을 이루지 못했죠.
# 그때는 정말 속상하고, 좌절도 많이 했었어요.
# 저는 항상 열심히만 하면 꿈을 이룰 수 있다고 생각했는데, 현실은 그렇지 않더라구요.
# 해외 음대를 목표로 준비했던 것들이 결국은 실패로 돌아가면서,
# 그때는 정말 힘들었어요.
# 물론 공부를 조금씩 해서 다른 전공으로 대학에 진학하기는 했지만,
# 그때의 상실감과 좌절감은 정말 컸어요.
# 왜냐면 해외 음대는 학비가 너무 비싸고 장학금도 없어서
# 그 꿈을 이루는 게 현실적으로 너무 어려웠거든요.
# 더군다나 그때는 집안도 힘들었어서 경제적으로도 많이 어려웠던 시기였거든요.
# 알바도 여러개 하면서 돈을 버는것이 정말 힘들었어요.
# 그때는 정말 막막하고, 미래가 너무 불안했었죠.
# 제 한달 월급이 제 주변 친구들의 용돈이였거든요.....
# 아직도 하나 기억나는 에피소드가 있어요.
# 알바가 끝나고 밤 12시쯤 기숙사로 돌아가는 길에
# 친구들은 술집에서 술을 마시고 있었어요.
# 그게 너무 부러웠던 기억이 나요.
# 술자리 보단 저렇게 쓸 수 있는 돈이 있다는게 부러웠어요.
# 주변에서 열심히산다! 라고 말해주시는 분들도 있었지만,
# 열심히 사는게 아니라 가난하니 열심히 살 수 밖에 없었던거였죠. ㅎㅎ
# 하루 세끼를 먹는것도 힘들었던 시기였어요.
# 아침은 굶고 점심은 컵라면 끓여서 면만 먹고
# 저녁은 퇴근후 남은 국물에 알바하는 가게에서 가져온 밥에 말아먹는게 일상이였거든요.
# 그때는 정말 막막했었죠.
# 이런거 보면 진짜.....
# 하... 삶은 왜 대체 이렇게 바램과는 반대로 구는게 참 너무하네요.
# 현실은 정말 냉정하다고 느꼈어요.
# 내가 열심히 준비했던 꿈이 이렇게 허무하게 무너질 줄은 정말 상상도 못했었거든요.
# 그때는 정말 많이 울었던것 같아요. 정말 힘들었어요. 그때는 정말 막막했었죠.
# 어릴때 아빠가 항상 "삶은 호락 호락하지 않아" 라고 말씀하셨는데,
# 전 그말에 "항상 나는 해당안돼" 라고 대답했던 제가
# 이제는 "삶은 호락 호락하지 않아" 라는 말이 정말 와닿는 나이가 되어 버렸던거죠....
# 그래서 1학년 한학기만 한 이후 빠르게 군대를 가게 되었어요.
# 어쩌면 당장의 현실을 받아들이기가 어려워
# 도망치듯이 군대를 간 것일지도 모르겠네요. ㅎㅎ
# 군대는 그래도 모두가 공평하게 사니깐요.
# 이렇게 스무살을 다시 되돌아 보면 막막했던 시기였던것 같아요.
# 스물 네살인 지금의 제가 보면 참 기특하기도 하네요 제가 ㅎㅎ
# 그 상황에서 비록 어떻게 보면 도망친것 처럼도 보이겠지만,
# 환경을 이겨내보려고 노력했던 그때의 저도 참 대단한 것 같아요.
# 참...그때는 정말 힘들었던 시기였던 것 같아요.
# 그래도 그때는 그 당시 여자친구가 정신적으로 많이 도와주었어요.
# 정말 고마웠던 기억이 나요.
# 어쩌면 가장 힘들었던 시기에 가장 큰 힘이 되어준 사람이었을지도 모르겠네요.
# 지금은 그때의 여자친구와는 헤어졌지만,
# 그때의 기억은 정말 소중한 추억으로 남아있어요.
# 아직도 그친구가 저에게 해준 말이 기억이나네요.
# "날마다 사라지는 젊은 시절이니깐 우리는 지금을 소중히 하자" 라고 말해줬었어요.
# 그친구 덕에 저는 정말 힘들었던 시기를 잘 버텨낼 수 있었던 것 같아요.
# 정말 고마운 친구였어요.
# 물론 안좋게 끝나진 않았지만 서로의 꿈과 지향점이 달라지게 되면서
# 군대 전역후 헤어지게 되었죠.
# 아쉽기도 하지만 서로의 행복을 위해서 어쩔 수 없는 선택이었던 것 같아요.
# 그 친구도 정말 멋진 친구였고,
# 저에게 정말 큰 힘이 되어주었던 친구였고
# 여러 방면으로 그 친구에게 많이 배웠던것 같아요.
# 지금 이렇게 저를 한층 더 좋은 사람으로 만들어 주었으니깐요. 정말 고마운 친구였어요.
# 그렇게 어느새 시간이 지나 각자 서로 행복 하길 바랄 뿐이지만
# 해가 지나면서 더 아름다워지는 그 친구 모습을 볼때면
# 주워 담을 수 없는 그런 추억들을 만들어준 그 친구에게
# 너무나 고맙고 감사한 마음이 들곤 해요.
# 그렇게 햇수로 약 7년간의 연애를 했었네요. 정말 긴 시간동안 함께 했던 것 같아요.
# 그렇게 군복무도 마치고 이별을 한 후에 진로를 고민하면서 정말 많은 고민과 불안이 있었어요.
# 그때 문득히 "그래도 내가 좋아하는 걸 해보자"라는 생각이 들었어요.
# 물론, 현실적인 고민도 많았어요. 취업이 잘 될까? 내가 이 길에서 성공할 수 있을까? 이런 걱정들이 많이 들었어요.
# 하지만 결국은 내가 좋아하는 걸 하는 게 가장 중요하다고 생각했어요.
# 그래서 지금 이 길을 선택하게 되었어요.
# 현실 앞에서 고민이 많아지기도 하죠.
# "내가 이 길을 선택하는 게 맞는 걸까?" , "내가 이 길에서 성공할 수 있을까?" 이런 걱정들이
# 우리의 앞을 가로막기 때문이겠죠
# 그래도 결국은 내가 좋아하는 걸 하지 않는다면 그게 더 큰 후회가 되지 않을까요?
# 물론, 그 과정에서 많은 고민과 불안도 있겠지만
# 결국은 내가 좋아하는 걸 하는 게 가장 중요할 것 같아요
# 망하더라도 내가 좋아하는걸 하다 망하는게 낫지, 내가 싫어하는걸 하다 망하는건 정말 최악이니까요.
# 그리하여 지금 이 길을 선택하게 되었습니다. ㅎㅎ
# 지금 이렇게 돌아보니... 저도 많이 변했네요.
# 아주 어릴때는 피아니스트가 되고 싶었는데,
# 지금은 코딩을 하고 데이터 분석 앱개발 백엔드 공부등 cs를 하고 있으니 말이죠 ㅎㅎ
# 어릴땐 마냥 행복하기만 했었던 것 같아요.
# 우리집이 경제적으로 어떤 상황이었는지,
# 내가 어떤 환경에서 자라고 있는지 이런 것들은 전혀 신경쓰지 않고 그냥 행복하기만 했던 것 같아요.
# 그때는 정말 아무 걱정도 없이 그냥 살아갔던것 같아요.
# 하지만 어른이 되면서 그런 행복만으로는 살아갈 수 없다는 걸 알게 되었어요.
# 현실 이라는 곳은 그리 호락 호락하지 않다는 걸 알게 되었고,
# 내가 원하는 걸 이루기 위해서는 노력과 희생이 필요하다는 것도 알게 되었어요.
# 어린 시절의 꿈이 이루어지지 않았을 때의 좌절감과 상실감도 경험했고,
# 그때의 힘들었던 시기도 겪으면서,
# 참...어른이 된다는 거 너무 어려운것 같아요.
# 작디 작지만 희망 가득했던 꼬마가
# 현실의 벽에 부딪히면서 좌절도 하고, 상실감도 느끼고,
# 그럼에도 불구하고 다시 일어서서 새로운 꿈을 꾸고,
# 도전도 하는 그런 과정이 참 쉽지 않은 것 같아요.
# 하지만 그런 변화 역시 자연스러운 과정이라고 생각해요.
# 우리가 겪는 모든 경험이 결국은 우리를 더 단단하게 만들고,
# 더 깊이 있는 사람으로 만들어준다고 믿습니다.
# 그래서 여러분이 코딩을 공부하는 이유가 무엇이든,
# 코딩이 아니 더라도 여러분이 좋아하는 걸 하는 이유가 무엇이든,
# 그 과정이 여러분을 성장시키고 있다면
# 그걸로 충분히 의미 있는 선택이라고 생각해요.
# 지금 이 순간에도 자기 길을 찾아가며 노력하고 있는 여러분,
# 정말 멋있고 대단한 사람들이에요.
# 우리 다같이 한번 지금 이 터미널을 보고있는 우리 자신에게 박수 한번 쳐보는 건 어떨까요? ㅎㅎ
# 이때까지 정말 열심히 했고
# 살아보려고 노력해왔던 우리 자신에게 말이죠.
# 인생의 주체는 결국 우리 자신이니까요.
# 그리고 그 주체를 진심으로 사랑해 줄 수있는 사람도 결국은 우리 자신이니까요.
# 그러니 지금 이 순간은 이 주크 박스 터미널 앞에서 우리 자신에게 박수를 쳐주면서
# 앞으로 나아가는 우리 자신을 응원해보는 건 어떨까요? ㅎㅎ
# 그리고 나에게 참 수고 했고, 앞으로도 잘 해낼 수 있을 거라고 말해주는 건 어떨까요? ㅎㅎ
# 우리 자신을 조금 보듬어 주고 사랑해 주는
# 지금 현재 가동중인 이 터미널 program이
# 그런 여유를 주는 program이 되었으면 해요.
# 지금 이 아니면 언제 또 이런 기회가 있을까요? ㅎㅎ
# 현실은 냉혹하고 빠르지만
# 지금 이 순간만큼은 우리 자신에게 조금 더 관대해지고,
# 우리 자신을 조금 더 사랑해 주는 그런 시간이 되었으면 좋겠어요.
# 조급해 한다고 해서 더 빨리 나아갈 수 있는 것도 아니고,
# 조급해 한다고 해서 더 좋은 결과가 나오는 것도 아니니까요.
# 그러니 우리 각자의 속도로, 각자의 이유로
# 계속 앞으로 나아가 봅시다.
# 같이 화이팅 해요 !
# 그리고 같이 우리 자신을 응원하면서
# 행복한 하루하루를 만들어 가보도록 해요. ㅎㅎ
# 지금까지 광운대학교 백준현 이였습니다.
# 감사합니다. ㅎㅎ
# adios!
# ps. 혹시 이 글을 읽으시는 분들 중에 저와 비슷한 경험을 하신 분들이 계시다면,
# 우리 같이 친구해요 ㅋㅋㅋ
# 그런김에 반말좀 할게용?ㅋㅋ
# 너도 가끔은 이유 없이 불안해질 때 있지.
# 너는 그런 날에도 결국 하루를 버텨내고 있잖아.
# 이 길이 맞는지 계속 스스로에게 묻게 되는 순간도 있을 거야.
# 미래가 보이지 않아서 겁이 날 때도 있겠지.
# 충분하지 않다고 느끼는 날도 분명 있을 거야.
# 히든처럼 보이지 않는 노력들도 사실은 다 쌓이고 있어.
# 잘하고 있는지 확신이 안 서는 날에도
# 하고 있는 그 하루가 결국 너의 길이 되는 거야.
# 고개를 들어보면 생각보다 멀리 와있는 너를 보게 될 거고,
# 있던 상처들도 결국 너를 더 단단하게 만들어줄 거야.
# 어쩌면 지금 이 순간이 제일 힘들 수도 있지만
# 사실 너는 이미 수없이 많은 걸 이겨낸 사람이야. 사랑은 멀리 있는 게 아니라 지금의 너 자신을 인정하는 것에서 시작해.
# 해낼 수 있다고, 지금도 충분히 잘하고 있다고 너 스스로를 응원해 주고 사랑했으면 해 ㅎㅎ   
# 그럼 안녕! 잘지내! ㅎㅎ
# 빠빠룽~ ㅋㅋ

from __future__ import annotations

import glob
import ctypes
import importlib
import sys
import threading
import time
from pathlib import Path

_PYGAME_MODULE = None


def load_pygame_module():
    global _PYGAME_MODULE
    if _PYGAME_MODULE is not None:
        return _PYGAME_MODULE
    try:
        _PYGAME_MODULE = importlib.import_module("pygame")
    except Exception:
        _PYGAME_MODULE = False
    return _PYGAME_MODULE


def get_resource_dir() -> Path:
    if getattr(sys, "frozen", False):
        return Path(getattr(sys, "_MEIPASS", Path(sys.executable).parent))
    return Path(__file__).parent


def get_launch_dir() -> Path:
    if getattr(sys, "frozen", False):
        return Path(sys.executable).parent
    return Path(__file__).parent

INTERVAL_SECONDS = 3.55
ACCENT_COLOR = "\033[95m"
BASE_COLOR = "\033[97m"
RESET = "\033[0m"
TARGET_TRACK_KEYS = ["2022.02.07", "2019.0322"]

SPECIAL_LINE_START = 156
SPECIAL_LINE_END = 168


def extract_comment_lines(source_path: Path) -> list[tuple[int, str]]:
    lines: list[tuple[int, str]] = []
    if not source_path.exists():
        return lines
    for line_number, raw in enumerate(source_path.read_text(encoding="utf-8").splitlines(), start=1):
        stripped = raw.lstrip()
        if stripped.startswith("#"):
            content = stripped[1:]
            if content.startswith(" "):
                content = content[1:]
            if content:
                lines.append((line_number, content))
    return lines


def color_one_char(text: str, position: int) -> str:
    if not text:
        return text
    if position < 0 or position >= len(text):
        return f"{BASE_COLOR}{text}{RESET}"
    left = text[:position]
    center = text[position]
    right = text[position + 1 :]
    return f"{BASE_COLOR}{left}{ACCENT_COLOR}{center}{BASE_COLOR}{right}{RESET}"


def color_prefix(text: str, length: int) -> str:
    if not text:
        return text
    if length <= 0:
        return f"{BASE_COLOR}{text}{RESET}"
    split_at = min(length, len(text))
    return f"{ACCENT_COLOR}{text[:split_at]}{BASE_COLOR}{text[split_at:]}{RESET}"


def apply_special_rule(
    line: str,
    source_line_number: int,
) -> str:
    if source_line_number < SPECIAL_LINE_START or source_line_number > SPECIAL_LINE_END:
        return f"{BASE_COLOR}{line}{RESET}"
    if source_line_number == 160:
        return color_prefix(line, 2)
    if source_line_number == 157:
        return color_one_char(line, 1)
    return color_one_char(line, 0)


def find_target_mp3s(search_dirs: list[Path]) -> list[Path]:
    selected: list[Path] = []
    for target_key in TARGET_TRACK_KEYS:
        found: Path | None = None
        for search_dir in search_dirs:
            matches = sorted(Path(path) for path in glob.glob(str(search_dir / f"*{target_key}*.mp3")))
            if matches:
                found = matches[0]
                break
        if found is not None:
            selected.append(found)
    return selected


def enable_windows_ansi() -> None:
    if sys.platform != "win32":
        return
    try:
        kernel32 = ctypes.windll.kernel32
        handle = kernel32.GetStdHandle(-11)
        mode = ctypes.c_uint32()
        if kernel32.GetConsoleMode(handle, ctypes.byref(mode)):
            kernel32.SetConsoleMode(handle, mode.value | 0x0004)
    except Exception:
        pass


def start_bgm(mp3_paths: list[Path]) -> tuple[bool, threading.Event | None, threading.Thread | None]:
    if len(mp3_paths) != len(TARGET_TRACK_KEYS):
        print("(안내) 요청한 배경음 파일(2022.02.07, 2019.0322)을 찾지 못했어요.")
        return False, None, None
    pygame_module = load_pygame_module()
    if not pygame_module:
        print("(안내) 배경음 재생을 위해 가상환경에서 `pip install -r requirements.txt` 설치가 필요해요.")
        return False, None, None

    def worker(stop_event: threading.Event) -> None:
        index = 0
        while not stop_event.is_set():
            current_path = mp3_paths[index]
            try:
                pygame_module.mixer.music.load(str(current_path))
                pygame_module.mixer.music.play()
            except Exception:
                break
            while not stop_event.is_set() and pygame_module.mixer.music.get_busy():
                time.sleep(0.2)
            index = (index + 1) % len(mp3_paths)

    try:
        pygame_module.mixer.init()
        stop_event = threading.Event()
        thread = threading.Thread(target=worker, args=(stop_event,), daemon=True)
        thread.start()
        return True, stop_event, thread
    except Exception:
        return False, None, None


def stop_bgm(
    is_playing: bool,
    stop_event: threading.Event | None,
    bgm_thread: threading.Thread | None,
) -> None:
    if stop_event is not None:
        stop_event.set()
    if bgm_thread is not None:
        bgm_thread.join(timeout=1.0)
    if not is_playing:
        return False
    try:
        pygame_module = load_pygame_module()
        if pygame_module:
            pygame_module.mixer.music.stop()
            pygame_module.mixer.quit()
    except Exception:
        pass


def play_jukebox() -> None:
    enable_windows_ansi()
    source_path = Path(__file__)
    resource_dir = get_resource_dir()
    launch_dir = get_launch_dir()
    lines = extract_comment_lines(source_path)
    if not lines:
        lines = extract_comment_lines(resource_dir / "for_you.py")
    if not lines:
        print("표시할 주석 텍스트가 없습니다.")
        return

    bgm_playing, bgm_stop_event, bgm_thread = start_bgm(find_target_mp3s([launch_dir, resource_dir]))

    try:
        for source_line_number, line in lines:
            styled = apply_special_rule(
                line=line,
                source_line_number=source_line_number,
            )
            print(styled, flush=True)
            time.sleep(INTERVAL_SECONDS)
    except KeyboardInterrupt:
        print("\n재생을 중지했습니다.")
    finally:
        stop_bgm(bgm_playing, bgm_stop_event, bgm_thread)


if __name__ == "__main__":
    play_jukebox()
